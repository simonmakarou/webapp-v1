<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Вариативная программа — генератор дня (Итерация 2)</title>

  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel for JSX in this single-file demo -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    *{ font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    body{ color:#111827; background:#F9FAFB; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .card{ box-shadow: 0 10px 15px -3px rgba(0,0,0,.06), 0 4px 6px -2px rgba(0,0,0,.03); }
    .subtle{ box-shadow:0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04); }
    .tap{ min-height:44px; min-width:44px; }
    .seg-active{ background:#111827; color:#fff }
    .seg-passive{ background:transparent; color:#111827 }
    .hide-scrollbar::-webkit-scrollbar{ display:none } .hide-scrollbar{ -ms-overflow-style:none; scrollbar-width:none }

    /* Done chip */
    .btn-done{ display:inline-flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:12px;background:#f3f4f6;
               color:#374151;border:1px solid #e5e7eb;transition:all .18s ease;box-shadow:0 1px 2px rgba(0,0,0,.04) }
    .btn-done:hover{ background:#eef2ff; border-color:#dbeafe }
    .btn-done.is-on{ background:linear-gradient(135deg,#10b981,#059669);color:#fff;border-color:transparent;
                     box-shadow:0 8px 18px rgba(16,185,129,.25), 0 2px 6px rgba(16,185,129,.15); animation: pop .24s ease-out }
    .btn-done svg{ width:18px; height:18px }

    @keyframes pop { 0%{ transform:scale(.9) } 100%{ transform:scale(1) } }
    .page{ opacity:0; transform: translateY(6px); transition: all .28s ease }
    .page.show{ opacity:1; transform: translateY(0) }

    /* Accordion */
    .acc-enter{ max-height:0; opacity:.0; overflow:hidden }
    .acc-enter.open{ max-height:1400px; opacity:1; transition:max-height .35s ease, opacity .35s ease }

    /* Steps */
    .instructions{ list-style:none; counter-reset:step; padding-left:0; }
    .instructions li{ counter-increment:step; display:flex; align-items:flex-start; margin:.5rem 0; font-size:.95rem; line-height:1.7 }
    .instructions li::before{ content:counter(step); font-weight:600; font-size:.75rem; color:#6b7280; border:1px solid #e5e7eb; background:#fff;
                               border-radius:9999px; width:1.5rem; height:1.5rem; display:flex; align-items:center; justify-content:center;
                               flex-shrink:0; margin-right:.6rem; margin-top:.2rem }

    /* Modal */
    .modal{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(17,24,39,.4); z-index:70 }
    .modal-card{ background:#fff; border-radius:16px; max-width:560px; width:92%; box-shadow:0 25px 50px -12px rgba(0,0,0,.25) }

    /* Timer */
    .timer-sheet{ position:fixed; left:0; right:0; bottom:0; background:#fff; border-top-left-radius:16px; border-top-right-radius:16px;
                  box-shadow:0 -10px 30px rgba(0,0,0,.15); z-index:80; }
    .timer-pill{ position:fixed; right:16px; bottom:16px; z-index:80; background:#111827; color:#fff; padding:.5rem .8rem; border-radius:9999px;
                 box-shadow:0 6px 18px rgba(0,0,0,.25) }
  </style>
</head>
<body class="antialiased">
  <div id="root"><div class="p-4">Загрузка интерфейса…</div></div>

  <!-- CDN guard -->
  <script>
    (function() {
      function show(msg) {
        var el = document.getElementById('root');
        if (el) el.innerHTML = '<div style="padding:16px;border:1px solid #fee2e2;background:#fef2f2;border-radius:12px;color:#991b1b;line-height:1.6">'+msg+'</div>';
      }
      if (!window.React || !window.ReactDOM) { show('Не удалось загрузить React/ReactDOM из CDN. Нужна офлайн‑сборка? Скажи — соберу.'); return; }
      if (!window.Babel) { show('Не удалось загрузить Babel (для JSX). Открой при доступном интернете или дам офлайн‑версию.'); return; }
      window.addEventListener('error', e => show('Ошибка: ' + (e && e.message ? e.message : 'неизвестно')));
      window.addEventListener('unhandledrejection', e => show('Ошибка (promise): ' + (e && e.reason && e.reason.message ? e.reason.message : 'неизвестно')));
    })();
  </script>

  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect, useRef, useMemo, useCallback, createContext, useContext } = React;

    // ---------- Icons ----------
    const Icon = ({ name, className="w-6 h-6", strokeWidth=1.5 }) => {
      const P = d => (<svg className={className} fill="none" stroke="currentColor" strokeWidth={strokeWidth} viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d={d}/></svg>);
      const S = d => (<svg className={className} viewBox="0 0 24 24" fill="currentColor"><path d={d}/></svg>);
      const M = {
        ChevronLeft: P("M15 19l-7-7 7-7"),
        ChevronDown: P("M19 9l-7 7-7-7"),
        Check: S("M9 16.2l-3.5-3.6L4 14.1l5 4.9L20 8.1l-1.5-1.4z"),
        Clock: P("M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"),
        User: P("M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"),
        Heart: P("M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"),
        Activity: P("M13 10V3L4 14h7v7l9-11h-7z"),
        Circle: P("M12 20a8 8 0 100-16 8 8 0 000 16z"),
        Play: S("M8 5v14l11-7z"),
        Pause: S("M6 4h4v16H6zm8 0h4v16h-4z"),
        Rotate: P("M1 4v6h6M3.51 15a9 9 0 108.49-12"),
        Close: P("M6 18L18 6M6 6l12 12"),
        Shuffle: P("M4 4h5l2 3-2 3H4m11-6l5 5-5 5"),
        Info: P("M13 16h-1v-4h-1m1-4h.01"),
        ArrowRight: P("M13 7l5 5-5 5m5-5H6"),
        List: P("M4 6h16M4 12h16M4 18h16")
      };
      return M[name] || <span/>;
    };

    // ---------- LS utils ----------
    const LS = {
      get(k,def){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):def; }catch{return def} },
      set(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }
    };

    const EQUIPMENT_LABELS = {
      none:'Без оборудования',
      mat:'Коврик',
      band:'Эспандер',
      wall:'Стена'
    };

    const EQUIPMENT_DEFAULTS = { mat:true, band:false, wall:true };

    // ---------- Seed per device ----------
    function uuid4(){
      const s = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
        const r = Math.random()*16|0, v = c==='x'?r:(r&0x3|0x8); return v.toString(16);
      });
      return s;
    }
    function ensureSeed(){
      let app = LS.get('app.meta', null);
      if (!app){ app = { seed: uuid4(), cycle: 1, schemaVersion: 1 }; LS.set('app.meta', app); }
      return app;
    }
    const APP = ensureSeed();

    // ---------- RNG ----------
    function mulberry32(a){ return function(){ var t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; } }
    function strSeed(s){ let h=2166136261; for (let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h = Math.imul(h, 16777619); } return h>>>0; }
    const rngFrom = (seedStr)=> mulberry32(strSeed(seedStr));

    // ---------- Data (subset, enriched) ----------
    const EX_STRETCH = [
      {id:'neck_decompress', name:'Декомпрессия шеи', duration:5, equipment:'none', tags:['area:neck','type:mobility','lvl:1','pos:sitting'],
        steps:['Сядь устойчиво, плечи вниз','Наклон головы вправо 20–30 сек','Вернись и повтори влево','Подбородок к груди 20 сек'],
        focus:['Тянемся макушкой','Выдох — отпускание'], mistakes:['Рывки','Поднятые плечи'],
        mechanism:'Снижение гипертонуса трапециевидной и лестничных', contraindications:'Головокружение — остановить',
        progressions:['neck_iso_antagonist'] },
      {id:'neck_iso_antagonist', name:'Изометрия антагонистов шеи', duration:6, equipment:'none', tags:['area:neck','type:stability','lvl:2','pos:sitting'],
        steps:['Ладонь к виску','Надави головой на ладонь 5 сек без движения','Расслабь 5 сек ×5 в стороны и вперёд'],
        focus:['Сохраняй нейтральный подбородок'], mistakes:['Переразгибание шеи'],
        mechanism:'Нормализация тонуса через ко-конракции', progressions:['neck_prone_cobra'] },
      {id:'neck_suboccipital_release', name:'Расслабление подзатылочных', duration:6, equipment:'towel', tags:['area:neck','type:mobility','lvl:1','pos:lying'],
        steps:['Лёжа на спине, валик из полотенца под затылком','Медленно покачивай голову «да/нет» 1 мин','Дыхание диафрагмой'],
        focus:['Минимальная амплитуда, контроль дыхания'], mistakes:['Жёсткие движения','Поднятые плечи'],
        mechanism:'Миофасциальный релиз коротких разгибателей', contraindications:'Головокружение или острая травма шеи'],
      {id:'neck_upper_trap_stretch', name:'Растяжка верхних трапеций', duration:7, equipment:'none', tags:['area:neck','type:mobility','lvl:2','pos:standing'],
        steps:['Встань устойчиво, плечи вниз','Одной рукой возьмись за противоположную кисть за спиной','Наклон головы в сторону 30 сек, поменяй стороны'],
        focus:['Таз стабилен, дыхание ровное'], mistakes:['Поворот корпуса','Подъём плеча'],
        mechanism:'Удлинение верхней трапеции для снижения напряжения', progressions:['neck_loaded_carry'] },
      {id:'neck_chin_tuck_wall', name:'Подбородок к стене', duration:5, equipment:'wall', tags:['area:neck','type:stability','lvl:2','pos:standing'],
        steps:['Спина и затылок у стены','Втяни подбородок, удлиняя шею','Удерживай 5 сек ×10 повторов'],
        focus:['Темя вверх, затылок в стену лёгкий контакт'], mistakes:['Сгибание корпуса','Поднятые плечи'],
        mechanism:'Активация глубоких сгибателей шеи', progressions:['neck_loaded_carry'] },
      {id:'neck_prone_cobra', name:'Прон кобра для шеи', duration:6, equipment:'mat', tags:['area:neck','type:stability','lvl:3','pos:lying'],
        steps:['Лёжа лицом вниз, лоб на полотенце','Подбородок внутрь, оторви грудь и руки, большие пальцы вверх','Удерживай 8 сек → расслабь 5 сек ×6'],
        focus:['Лопатки вниз и внутрь','Темя тянется вперёд'], mistakes:['Переразгибание поясницы','Рывки'],
        mechanism:'Координация задней цепи шеи и межлопаточных', contraindications:'Острая боль в плечах'],
      {id:'neck_loaded_carry', name:'Фермерская переноска с осанкой', duration:7, equipment:'dumbbell', tags:['area:neck','type:stability','lvl:3','pos:standing'],
        steps:['Возьми умеренный вес в каждую руку','Плечи опущены, подбородок втянут','Пройди 30–40 м ×3 подхода'],
        focus:['Статическая стабильность шеи','Равномерное давление стоп'], mistakes:['Пожимание плечами','Задранный подбородок'],
        mechanism:'Интеграция стабилизаторов шеи и корпуса', contraindications:'Острая компрессия шеи'] },
      {id:'door_pec', name:'Грудные у дверного проёма', duration:6, equipment:'wall', tags:['area:shoulder','type:mobility','lvl:1','pos:standing'],
        steps:['Предплечья на косяки 90°','Плавно корпус вперёд 30 сек','Подними руки до 120° и повтори'],
        focus:['Грудь раскрыта, поясница нейтральна'], mistakes:['Провал в пояснице'],
        mechanism:'Растяжение малой грудной, улучшение постуры' },
      {id:'shoulder_sleeper', name:'Sleeper stretch', duration:6, equipment:'mat', tags:['area:shoulder','type:mobility','lvl:1','pos:lying'],
        steps:['Лёжа на боку, плечо и локоть 90°','Другой рукой мягко опусти предплечье вниз 30 сек','Сменить сторону'],
        focus:['Плечо прижато к полу'], mistakes:['Перерастяжение','Поворот корпуса'],
        mechanism:'Улучшение внутренней ротации плеча', contraindications:'Острая травма манжеты'],
      {id:'shoulder_wall_slide', name:'Скольжения по стене', duration:5, equipment:'wall', tags:['area:shoulder','type:mobility','lvl:2','pos:standing'],
        steps:['Спина к стене, локти 90°','Скользи вверх сохраняя контакт','Опусти вниз ×12'],
        focus:['Рёбра вниз, таз нейтрален'], mistakes:['Переразгибание поясницы'],
        mechanism:'Контроль лопаток и подъём рук'],
      {id:'shoulder_prone_t', name:'Прон T‑разведения', duration:6, equipment:'mat', tags:['area:shoulder','type:stability','lvl:2','pos:lying'],
        steps:['Лёжа на животе, руки в стороны T','Подними руки, большие пальцы вверх','Пауза 2 сек ×12'],
        focus:['Лопатки вниз и внутрь'], mistakes:['Напряжение шеи'],
        mechanism:'Укрепление задней дельты и ромбовидных'],
      {id:'shoulder_band_er', name:'Внешняя ротация резинкой', duration:7, equipment:'band', tags:['area:shoulder','type:stability','lvl:2','pos:standing'],
        steps:['Резинка закреплена, локоть 90° прижат','Поверни предплечье наружу 2 сек вверх/вниз ×15','Смена рук'],
        focus:['Локоть у корпуса'], mistakes:['Развод локтя','Излишнее напряжение трапеций'],
        mechanism:'Активация ротаторной манжеты', progressions:['shoulder_kb_arm_bar'] },
      {id:'shoulder_serratus_press', name:'Жим вперёд с активацией зубчатой', duration:6, equipment:'band', tags:['area:shoulder','type:stability','lvl:3','pos:standing'],
        steps:['Резинка вокруг ладоней, руки перед собой','Выпрямляя руки, протолкни лопатки вперёд','Контроль возврата ×12'],
        focus:['Рёбра вниз, шея длинная'], mistakes:['Переразгибание поясницы'],
        mechanism:'Улучшение стабилизации лопатки'],
      {id:'shoulder_kb_arm_bar', name:'Arm Bar с гирей', duration:8, equipment:'kettlebell', tags:['area:shoulder','type:stability','lvl:3','pos:lying'],
        steps:['Лёжа на спине, выжим гирю вверх','Повернись в бок/полубридж, взгляд на гирю','Удерживай 20–30 сек/сторону ×3'],
        focus:['Лопатка упакована','Дыхание спокойное'], mistakes:['Скручивание поясницы','Потеря фиксации'],
        mechanism:'Стабилизация плеча в overhead', contraindications:'Острая нестабильность плеча' },
      {id:'tspine_rotation', name:'Ротация грудного отдела', duration:6, equipment:'mat', tags:['area:tspine','type:mobility','lvl:1','pos:sitting'],
        steps:['Сидя, руки на груди','Поворот вправо + 3 микропружины + удержание','Повтор влево ×3'],
        mechanism:'Увеличение ротации T‑spine' },
      {id:'tspine_thread_needle', name:'Продевание иглы', duration:6, equipment:'mat', tags:['area:tspine','type:mobility','lvl:1','pos:quadruped'],
        steps:['Встань на четвереньки','Проведи рукой под туловищем → вдох','На выдохе раскрой руку вверх ×8/сторону'],
        focus:['Таз стабилен'], mistakes:['Провал в пояснице'],
        mechanism:'Комбинация ротации и разгибания'],
      {id:'tspine_open_book', name:'Открытая книга', duration:7, equipment:'mat', tags:['area:tspine','type:mobility','lvl:1','pos:lying'],
        steps:['Лёжа на боку, колени согнуты','Открой верхнюю руку назад касаясь пола','Удерживай 30 сек ×2/сторону'],
        focus:['Колени прижаты'], mistakes:['Перекос таза'],
        mechanism:'Ротация грудного отдела с фиксацией таза'],
      {id:'tspine_extension_foam', name:'Разгибание на ролле', duration:6, equipment:'foamroller', tags:['area:tspine','type:mobility','lvl:2','pos:lying'],
        steps:['Ляг на валик под грудным отделом','Переплети руки, мягко разгибайся','Смести ролл на сегмент выше/ниже ×10'],
        focus:['Движение из грудного отдела'], mistakes:['Гиперэкстензия шеи'],
        mechanism:'Локальное разгибание T‑spine', contraindications:'Остеопороз в стадии обострения'],
      {id:'tspine_seated_cars', name:'Сидячие CARs грудного отдела', duration:7, equipment:'none', tags:['area:tspine','type:mobility','lvl:2','pos:sitting'],
        steps:['Сядь ровно, руки на плечах','Выполни полный круг корпусом, сегментируя грудной отдел','По 3 круга в каждую сторону'],
        focus:['Контроль дыхания'], mistakes:['Потеря нейтрали таза'],
        mechanism:'Нейроконтроль и диапазон движения'],
      {id:'tspine_kneeling_windmill', name:'Ветряная мельница в полуприседе', duration:8, equipment:'none', tags:['area:tspine','type:mobility','lvl:3','pos:kneeling'],
        steps:['Встань в выпад на колене','Нижняя рука на полу, верхняя тянется вверх','Поверни грудь к небу 10 повторов/сторону'],
        focus:['Задняя нога активна, таз квадрат'], mistakes:['Провисание плеча'],
        mechanism:'Интеграция ротации грудного отдела с тазом', progressions:['tspine_prayer_bench'] },
      {id:'tspine_prayer_bench', name:'Молитва на скамье', duration:7, equipment:'bench', tags:['area:tspine','type:mobility','lvl:3','pos:kneeling'],
        steps:['Колени на полу, локти на скамье','Опусти грудь вниз, ладони соединены','Удерживай 30 сек ×2'],
        focus:['Живот подтянут'], mistakes:['Перегиб в пояснице'],
        mechanism:'Разгибание грудного отдела и латиссима'] },
      {id:'neuro_sciatic', name:'Нейродинамика седалищного нерва', duration:7, equipment:'mat', tags:['area:hamstrings','type:neuro','lvl:1','pos:lying'],
        steps:['Лёжа, подтяни колено','Выпрямляй голень до натяжения','Носок на себя 30 сек ×2/ногу'],
        mechanism:'Улучшение скольжения нерва', contraindications:'Острая радикулопатия — только с терапевтом' },
      {id:'hip_flexor_release', name:'Релиз подвздошно‑поясничной', duration:8, equipment:'mat', tags:['area:hips','type:mobility','lvl:2','pos:kneeling'],
        steps:['Низкий выпад','Таз вперёд/вниз, корпус вертикален','Руку вверх + наклон в сторону 45 сек'],
        focus:['Задняя ягодица активна'], mistakes:['Прогиб поясницы'],
        mechanism:'Восстановление нейтрального таза' },
      {id:'hips_90_90_switch', name:'90/90 переключения', duration:7, equipment:'none', tags:['area:hips','type:mobility','lvl:1','pos:sitting'],
        steps:['Сядь в 90/90, грудь вперёд','Перекати колени в другую сторону без помощи рук','10–12 переключений'],
        focus:['Движение от таза'], mistakes:['Сутулость'],
        mechanism:'Улучшение наружной/внутренней ротации бедра'],
      {id:'hips_piriformis_stretch', name:'Растяжка грушевидной', duration:7, equipment:'mat', tags:['area:hips','type:mobility','lvl:1','pos:lying'],
        steps:['Лёжа на спине, щиколотку на колене','Подтяни бедро к груди 30 сек','Сменить сторону'],
        focus:['Поясница прижата'], mistakes:['Поднятое плечо'],
        mechanism:'Снятие напряжения глубоких ротаторов'],
      {id:'hips_cossack_squat', name:'Казачьи приседы', duration:8, equipment:'none', tags:['area:hips','type:mobility','lvl:2','pos:standing'],
        steps:['Ноги широко, носки слегка наружу','Сядь в бок, другая нога прямая','Перекатывайся 8–10 раз'],
        focus:['Пятка опорной ноги прижата'], mistakes:['Колено заваливается внутрь'],
        mechanism:'Латеральная гибкость и сила бёдер', progressions:['hips_jefferson_curl'] },
      {id:'hips_pigeon_flow', name:'Поток голубя', duration:8, equipment:'mat', tags:['area:hips','type:mobility','lvl:2','pos:lying'],
        steps:['Из планки выведи колено вперёд к запястью','Опусти таз и грудь на опору','Микродвижения вперёд-назад 60 сек/сторону'],
        focus:['Таз квадрат','Дыхание ровное'], mistakes:['Завал на бок'],
        mechanism:'Удлинение наружных ротаторов и сгибателей бедра'],
      {id:'hips_jefferson_curl', name:'Джефферсон-кёрл', duration:6, equipment:'lightweight', tags:['area:hips','type:mobility','lvl:3','pos:standing'],
        steps:['Встань на тумбу, лёгкий вес в руках','Медленно скручивайся вниз позвонок за позвонком','Подъём в обратном порядке ×8'],
        focus:['Вес равномерно на стопах'], mistakes:['Рывок внизу','Чрезмерный вес'],
        mechanism:'Контролируемое удлинение задней цепи', contraindications:'Острая грыжа диска'] },
      {id:'posterior_chain', name:'Растяжка задней цепи', duration:8, equipment:'mat', tags:['area:hamstrings','type:mobility','lvl:2','pos:sitting'],
        steps:['Сидя, ноги прямые','Наклон от таза, спина ровная 30 сек','Вариант «дерево» по очереди'],
        focus:['Живот подтянут'], mistakes:['Скругление спины'],
        mechanism:'Комплексное удлинение задней линии' },
      {id:'hamstring_wall_stretch', name:'Растяжка у стены', duration:7, equipment:'wall', tags:['area:hamstrings','type:mobility','lvl:1','pos:lying'],
        steps:['Лёжа у стены, одна нога вверх, другая прямая на полу','Мягко выпрями колено и носок на себя 45 сек','Смена ног'],
        focus:['Поясница прижата'], mistakes:['Сгиб нижней ноги'],
        mechanism:'Удлинение задней поверхности бедра'],
      {id:'hamstring_isometric_bridge', name:'Изометрический мост с пятками', duration:6, equipment:'mat', tags:['area:hamstrings','type:stability','lvl:2','pos:lying'],
        steps:['Лёжа, пятки на полу ближе к тазу','Подними таз, удерживай 20 сек ×3','Прогрессия: одна нога'],
        focus:['Рёбра вниз, ягодицы активны'], mistakes:['Переразгибание поясницы'],
        mechanism:'Укрепление задней цепи в изометрии'],
      {id:'hamstring_goodmorning', name:'Good morning с палкой', duration:6, equipment:'stick', tags:['area:hamstrings','type:mobility','lvl:2','pos:standing'],
        steps:['Палка вдоль позвоночника','Слегка согни колени, таз назад','Наклон до натяжения → возврат ×12'],
        focus:['Нейтральная спина'], mistakes:['Скругление'],
        mechanism:'Хип-хиндж с акцентом на удлинение мышц'],
      {id:'hamstring_single_leg_rdl', name:'Одноногий РДТ', duration:7, equipment:'dumbbell', tags:['area:hamstrings','type:stability','lvl:3','pos:standing'],
        steps:['Встань на одну ногу, другой ногой назад','Наклон от бедра, спина ровная','Возврат ×10/сторону'],
        focus:['Таз ровный'], mistakes:['Разворот таза наружу'],
        mechanism:'Комбинация растяжки и силы в задней цепи'],
      {id:'hamstring_walkout', name:'Выходы мостика на пятки', duration:6, equipment:'mat', tags:['area:hamstrings','type:stability','lvl:3','pos:lying'],
        steps:['Из ягодичного моста шагая пятками вперёд 4 шага','Задержка 2 сек → вернись назад','3 подхода'],
        focus:['Таз стабилен'], mistakes:['Провисание таза'],
        mechanism:'Экцентрическая сила бицепса бедра' },
      {id:'ankle_mob', name:'Активная мобилизация голеностопа', duration:5, equipment:'none', tags:['area:ankle','type:mobility','lvl:1','pos:standing'],
        steps:['15 тыльных/подошвенных сгибаний','15 кругов в каждую сторону','20 подъёмов на носки с паузой 2 сек'],
        focus:['Движение во всех осях','Контроль стопы на полу'], mistakes:['Рывки','Отрыв пятки при подъёме'],
        mechanism:'Активация венозной помпы, рост ROM' },
      {id:'ankle_kneeling_drive', name:'Проталкивание колена вперёд', duration:5, equipment:'none', tags:['area:ankle','type:mobility','lvl:1','pos:kneeling'],
        steps:['Встань на колено перед стеной','Проталкивай колено вперёд не отрывая пятку','По 12 повторов/сторону'],
        focus:['Таз квадрат'], mistakes:['Отрыв пятки'],
        mechanism:'Улучшение тыльного сгибания'],
      {id:'ankle_band_dorsiflex', name:'Дорсифлексия с резинкой', duration:6, equipment:'band', tags:['area:ankle','type:mobility','lvl:2','pos:kneeling'],
        steps:['Резинка на шейке голеностопа, тянет назад','Выполни выпады вперёд 12 раз/сторону','Контроль пятки'],
        focus:['Колено над вторым пальцем'], mistakes:['Коллапс внутрь'],
        mechanism:'Дистракция сустава и мобилизация тыла'],
      {id:'ankle_eversion_strength', name:'Эверсия с мини-лентой', duration:6, equipment:'band', tags:['area:ankle','type:stability','lvl:2','pos:sitting'],
        steps:['Сидя, лента вокруг стоп, тянет внутрь','Отводи стопу наружу 2 сек вверх/вниз ×15','Смена ног'],
        focus:['Движение из голеностопа'], mistakes:['Ротация бедра'],
        mechanism:'Укрепление малоберцовых'],
      {id:'ankle_calf_raise_single', name:'Одноногие подъёмы', duration:6, equipment:'step', tags:['area:ankle','type:stability','lvl:3','pos:standing'],
        steps:['Встань на край степа на одной ноге','Опусти пятку ниже уровня, поднимись вверх 3 сек','12 повторов/сторону ×2'],
        focus:['Полный диапазон'], mistakes:['Завал внутрь'],
        mechanism:'Сила икроножных и контроль голеностопа'],
      {id:'ankle_multidirectional_hops', name:'Многоплоскостные прыжки', duration:5, equipment:'none', tags:['area:ankle','type:stability','lvl:3','pos:standing'],
        steps:['Разметь крест на полу','Прыгай по линиям вперёд-назад, в стороны 20 сек','Смена ног'],
        focus:['Мягкое приземление'], mistakes:['Громкий удар пяткой'],
        mechanism:'Реактивная устойчивость голеностопа', contraindications:'Острая нестабильность голеностопа' }
    ];

    const EX_LFK = [
      {id:'quad_iso', name:'Изометрия квадрицепса', duration:6, equipment:'mat', tags:['area:core','type:stability','lvl:1'],
        steps:['Выпрями ногу','Прижимай колено 8 сек → расслабь 3 сек ×12'],
        mechanism:'Нейромышечный контроль без осевой нагрузки' },
      {id:'deep_core', name:'Глубокие стабилизаторы (TA/multifidus)', duration:6, equipment:'mat', tags:['area:core','type:stability','lvl:2'],
        steps:['Лёжа, колени 90°','Втяни живот на ~30%, удерживай 10 сек','Отдых 5 сек ×15'],
        mechanism:'Активация поперечной и межостистых' },
      {id:'wall_squat', name:'Присед у стены', duration:7, equipment:'wall', tags:['area:hips','type:strength','lvl:2'],
        steps:['Спина по стене до ~90°','Пауза 3–5 сек, медленный подъём ×10–15'],
        mechanism:'Сила ног без компрессии' },
      {id:'bridge', name:'Ягодичный мост', duration:6, equipment:'mat', tags:['area:hips','type:strength','lvl:1'],
        steps:['Колени 90°','Сжать ягодицы — подъём таза','Пауза 3 сек ×15 ×2'],
        mechanism:'Стабилизация таза' },
      {id:'single_leg_balance', name:'Баланс на одной ноге', duration:6, equipment:'none', tags:['area:balance','type:balance','lvl:1'],
        steps:['Удерживай 20–45 сек','Усложнение: закрыть глаза/повороты головы'],
        mechanism:'Проприоцепция стопы и голени' },
      {id:'dead_bug', name:'Dead Bug (анти‑ротация)', duration:6, equipment:'mat', tags:['area:core','type:stability','lvl:2'],
        steps:['Лёжа, руки вверх, колени 90°','Опускай противоположные рука/нога','Поясница к полу'],
        mechanism:'Антиротационный контроль' },
      {id:'heel_raise', name:'Подъёмы на носки', duration:5, equipment:'none', tags:['area:ankle','type:strength','lvl:1'],
        steps:['20 подъёмов на носки','Пауза 2 сек вверху ×2–3 подхода'],
        mechanism:'Икроножные, венозная помпа' }
    ];

    const EX_MEDIT = [
      {id:'478', name:'Дыхание 4‑7‑8', duration:10, equipment:'none', tags:['area:breath','type:breath','lvl:1'],
        steps:['Выдох ртом','Вдох носом 4','Пауза 7','Выдох 8 ×4–8 циклов'],
        mechanism:'Активация парасимпатики, снижение ЧСС' },
      {id:'pmr', name:'Прогрессивная релаксация', duration:15, equipment:'mat', tags:['area:breath','type:awareness','lvl:1'],
        steps:['Напряги мышцу 7 сек → расслабь 15 сек','Стопы→голени→бёдра→ягодицы→живот→спина→плечи→руки→шея→лицо'],
        mechanism:'Обучение напряжение/релаксация' },
      {id:'body_scan', name:'Body Scan', duration:20, equipment:'mat', tags:['area:breath','type:awareness','lvl:2'],
        steps:['Лёжа, внимание сверху вниз','30–60 сек на сегмент, без оценки'],
        mechanism:'Развитие интероцепции' },
      {id:'anapanasati', name:'Анапанасати', duration:20, equipment:'none', tags:['area:breath','type:breath','lvl:2'],
        steps:['Сядь ровно','Естественное дыхание, счёт до 10 и заново','Возвращай внимание без самоосуждения'],
        mechanism:'Устойчивое внимание' },
      {id:'metta', name:'Metta (доброжелательность)', duration:15, equipment:'none', tags:['area:breath','type:awareness','lvl:1'],
        steps:['Пожелания благополучия: себе → близкому → нейтральному → сложному человеку → всем'],
        mechanism:'Аффилиативные сети, эмоциональная регуляция' }
    ];

    const EX_LOOKUP = {};
    [...EX_STRETCH, ...EX_LFK, ...EX_MEDIT].forEach(ex => { EX_LOOKUP[ex.id] = ex; });

    // ---------- Themes ----------
    const THEMES = [
      { id:'mon_posture',  dow:1, title:'Осанка и шея',           pools:['area:neck','area:tspine'],     include:['type:mobility','type:stability','type:balance'] },
      { id:'tue_shoulders',dow:2, title:'Плечи и грудной',        pools:['area:shoulder','area:tspine'], include:['type:mobility','type:stability'] },
      { id:'wed_posterior', dow:3, title:'Таз и задняя цепь',     pools:['area:hips','area:hamstrings'], include:['type:mobility','type:strength'] },
      { id:'thu_ankle',     dow:4, title:'Стопа и голеностоп',    pools:['area:ankle','area:balance'],   include:['type:mobility','type:strength'] },
      { id:'fri_integration',dow:5,title:'Интеграция и координация', pools:['area:core','area:balance'], include:['type:stability','type:balance'] },
      { id:'sat_deload',    dow:6, title:'Длинная прогулка + мобилити', pools:['area:hips','area:tspine'], include:['type:mobility'] },
      { id:'sun_active',    dow:7, title:'Активное восстановление', pools:['area:breath','area:balance','area:neck','area:tspine','area:shoulder','area:hips','area:hamstrings'], include:['type:awareness','type:breath','type:mobility'] },
    ];

    const GOAL_CONFIG = {
      rehab: {
        factor: 0.75,
        title: 'Реабилитация',
        description: 'Мягкий объём, упор на восстановление и безопасность.'
      },
      prevent: {
        factor: 1.0,
        title: 'Профилактика',
        description: 'Базовая поддержка и снятие напряжений в течение недели.'
      },
      support: {
        factor: 1.15,
        title: 'Поддержка формы',
        description: 'Чуть больше объёма и прогрессии для регулярной практики.'
      }
    };

    const GOAL_OPTIONS = [
      { id:'rehab', title:'Реабилитация', description:'после травмы/болезни' },
      { id:'prevent', title:'Профилактика', description:'сидячая работа, дискомфорт' },
      { id:'support', title:'Поддержка формы', description:'регулярная практика' }
    ];

    // ---------- Helpers ----------
    const typeOf = ex => (ex.tags.find(t=>t.startsWith('type:'))||'type:mobility');
    const areaOf = ex => (ex.tags.find(t=>t.startsWith('area:'))||'area:unknown');
    const levelOf = ex => (ex.tags.find(t=>t.startsWith('lvl:'))||'lvl:1');
    const anyTag = (ex, tags) => tags.some(t => ex.tags.includes(t));
    const filterByPools = (exs, pools) => exs.filter(ex => anyTag(ex, pools));
    const filterByEquipment = (exs, equipment={}) => {
      return exs.filter(ex => {
        const need = ex.equipment || 'none';
        if (need==='none') return true;
        return !!equipment[need];
      });
    };
    const normalizePainAreas = pain => Array.isArray(pain) ? pain : pain ? [pain] : [];
    const filterByGoal = (exs, goal) => {
      return exs.filter(ex => {
        const lvl = parseInt(levelOf(ex).split(':')[1],10) || 1;
        const type = typeOf(ex);
        if (goal==='rehab'){
          if (type==='type:strength') return false;
          return lvl===1;
        }
        if (goal==='support'){
          return lvl<=3;
        }
        // профилактика — уровни 1-2
        return lvl<=2;
      });
    };
    const filterByPain = (exs, painAreas) => {
      const painMap = {
        'шея':['area:neck'], 'плечо':['area:shoulder','area:tspine'],
        'таз/спина':['area:hips','area:core'], 'задняя цепь':['area:hamstrings'],
        'стопа/голеностоп':['area:ankle']
      };
      const list = normalizePainAreas(painAreas);
      const ban = new Set(); list.forEach(p => (painMap[p]||[]).forEach(t=>ban.add(t)));
      return exs.filter(ex => !ex.tags.some(t => ban.has(t)));
    };
    const filterByLevelRPE = (exs, rpe, lowStreak) => {
      if (rpe>=7) return exs.filter(ex => ['lvl:1','lvl:2'].includes(levelOf(ex)));
      if (lowStreak>=2 && rpe<=3) return exs.filter(ex => levelOf(ex)!=='lvl:1').concat(exs.filter(ex => levelOf(ex)==='lvl:1'));
      return exs;
    };
    const excludeStrengthIfHighRPE = (exs, rpe, goal) => {
      if (goal==='rehab') return exs.filter(ex => typeOf(ex)!=='type:strength');
      return rpe>=7 ? exs.filter(ex => typeOf(ex)!=='type:strength') : exs;
    };

    // rarity ranking support
    function countUsage(ids){
      const log = LS.get('plan.log', []);
      const map = new Map();
      ids.forEach(id => map.set(id, 0));
      log.forEach(id => { if (map.has(id)) map.set(id, map.get(id)+1); });
      return map;
    }

    // greedy minute packer with type diversity and ±10% tolerance
    function packByMinutes(rng, candidates, requiredTypes, targetMin, lastAreas, options={}){
      const tol = options.tolerance ?? 0.10;
      const minMin = Math.round(targetMin*(1-tol));
      const maxMin = Math.round(targetMin*(1+tol));
      if (targetMin <= 0 || (minMin <= 0 && maxMin <= 0)){
        return [];
      }
      let pool = candidates.slice();
      // deprioritize last primary area
      if (lastAreas && lastAreas.length){
        const la = lastAreas[0];
        pool.sort((a,b)=> (areaOf(a)===la)-(areaOf(b)===la) || a.duration-b.duration);
      } else {
        pool.sort((a,b)=> a.duration-b.duration);
      }
      const byType = t => pool.filter(ex => typeOf(ex)===t);
      let picked = [];
      // ensure required types first
      requiredTypes.forEach(t => {
        const arr = byType(t);
        if (arr.length){
          picked.push(arr[Math.floor(rng()*arr.length)]);
          pool = pool.filter(ex => ex.id!==picked[picked.length-1].id);
        }
      });
      let sum = picked.reduce((s,x)=>s+x.duration,0);
      // fill to minMin
      while (sum < minMin && pool.length){
        // choose item that best fits remaining
        const remaining = minMin - sum;
        pool.sort((a,b)=> Math.abs(a.duration-remaining) - Math.abs(b.duration-remaining));
        const next = pool.shift();
        if (!next) break;
        picked.push(next);
        sum += next.duration;
      }
      // trim if above max
      while (sum > maxMin && picked.length>1){
        // try removing the item that reduces overshoot most while keeping >= requiredTypes in set
        let removed = false;
        for (let i=picked.length-1; i>=0; i--){
          const t = typeOf(picked[i]);
          const countT = picked.filter(x=>typeOf(x)===t).length;
          if (countT>1){ // keep at least one per type
            sum -= picked[i].duration;
            picked.splice(i,1);
            removed = true;
            if (sum<=maxMin) break;
          }
        }
        if (!removed) break;
      }
      return picked;
    }

    // Replace ranking
    function rankAlternatives(ex, cand){
      const lvlNum = l => parseInt((l||'lvl:1').split(':')[1],10)||1;
      const exLvl = lvlNum(levelOf(ex));
      const usage = countUsage(cand.map(c=>c.id));
      return cand.map(c => {
        const score = (areaOf(c)===areaOf(ex)?3:0) + (typeOf(c)===typeOf(ex)?2:0) - Math.abs(lvlNum(levelOf(c))-exLvl) + (4/(1+(usage.get(c.id)||0)));
        const reason = [
          areaOf(c)===areaOf(ex)?'та же область':null,
          typeOf(c)===typeOf(ex)?'тот же тип':null,
          `уровень ${levelOf(c).split(':')[1]}`
        ].filter(Boolean).join(', ');
        return { ...c, __score: score, __why: reason };
      }).sort((a,b)=> b.__score - a.__score);
    }

    // ---------- Timer context (persist across nav) ----------
    const TimerCtx = createContext(null);
    const useTimer = () => useContext(TimerCtx);
    function TimerProvider({ children }){
      const [state,setState] = useState(()=>LS.get('timer.state',{time:0,target:0,run:false,collapsed:false,label:''}));
      useEffect(()=>LS.set('timer.state', state),[state]);
      // ticking
      useEffect(()=>{
        if (!state.run || state.time<=0) return;
        const id = setInterval(()=>setState(p=>({...p,time:p.time-1})),1000);
        return ()=>clearInterval(id);
      },[state.run, state.time]);
      const start = (min,label='') => setState({ time:min*60, target:min*60, run:true, collapsed:false, label });
      const pause = ()=> setState(p=>({...p, run:!p.run }));
      const reset = ()=> setState(p=>({...p, time:p.target, run:false }));
      const close = ()=> setState({ time:0,target:0,run:false,collapsed:false,label:'' });
      const collapse = ()=> setState(p=>({...p, collapsed:true }));
      const expand = ()=> setState(p=>({...p, collapsed:false }));

      return <TimerCtx.Provider value={{state,start,pause,reset,close,collapse,expand}}>{children}</TimerCtx.Provider>
    }
    const fmt = s => `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;

    // ---------- Components ----------
    const Segmented = ({active,onChange}) => (
      <div className="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-gray-100">
        <div className="max-w-7xl mx-auto px-4 py-3">
          <div className="flex items-center justify-between gap-2 bg-gray-100 rounded-xl p-1">
            {['overview','program','progress','profile'].map(k=>(
              <button key={k} className={"tap px-4 py-2 rounded-lg text-sm "+(active===k?'seg-active':'seg-passive')} onClick={()=>onChange(k)}>
                {k==='overview'?'Обзор':k==='program'?'Программа':k==='progress'?'Прогресс':'Профиль'}
              </button>
            ))}
          </div>
        </div>
      </div>
    );

    const ExerciseItem = ({ ex, onReplace, onStartTimer, done, onToggleDone, goal }) => {
      const [open,setOpen]=useState(false);
      const equipmentLabel = EQUIPMENT_LABELS[ex.equipment||'none'] || EQUIPMENT_LABELS.none;
      return (
        <div className={"border-b border-gray-100 last:border-b-0 "+(open?'bg-white':'hover:bg-gray-50')}>
          <div className="flex items-center justify-between p-4">
            <div className="flex-1 pr-4">
              <h4 className={`font-medium text-base ${done?'text-gray-400 line-through':'text-gray-800'}`}>{ex.name}</h4>
              <div className="text-xs text-gray-500 mt-1 flex items-center gap-2">
                <span>~ {ex.duration} мин</span>
                <span className="w-1 h-1 bg-gray-300 rounded-full" aria-hidden="true"></span>
                <span>{equipmentLabel}</span>
              </div>
            </div>
            <div className="flex items-center gap-3">
              <div className="flex flex-col items-center">
                <button onClick={onToggleDone} className={`btn-done ${done?'is-on':''}`} aria-pressed={!!done} aria-label={done?'Отметить как невыполненное':'Отметить как выполненное'}>
                  <Icon name="Check" className={`w-5 h-5 ${done?'text-white':'text-gray-400'}`} />
                </button>
                <span className="text-[11px] text-gray-500 mt-1">Выполнено</span>
              </div>
              <div className="flex items-center gap-2">
                <button onClick={()=>setOpen(o=>!o)} className="px-3 py-1.5 rounded-lg border border-gray-200 text-gray-700 text-sm" aria-expanded={open}>{open?'Свернуть':'Показать'}</button>
                <button onClick={()=>onReplace(ex)} className="px-2.5 py-1.5 rounded-lg border border-gray-200 text-gray-700 text-sm flex items-center gap-1" aria-label="Заменить упражнение"><Icon name="Shuffle" className="w-4 h-4" /> Заменить</button>
              </div>
            </div>
          </div>
          <div className={"acc-enter "+(open?'open':'')}>
            <div className="px-4 pb-5">
              {ex.steps && ex.steps.length>0 && (
                <div className="mb-3">
                  <div className="text-xs font-semibold text-gray-600 uppercase tracking-wider mb-2">Шаги</div>
                  <ol className="instructions text-gray-700">{ex.steps.map((s,i)=><li key={i}>{s.endsWith('.')?s:s+'.'}</li>)}</ol>
                </div>
              )}
              {ex.focus && ex.focus.length>0 && (
                <div className="mb-2"><div className="text-xs font-semibold text-gray-600 uppercase mb-1">Фокус</div><ul className="list-disc pl-5 text-sm text-gray-700">{ex.focus.map((s,i)=><li key={i}>{s}</li>)}</ul></div>
              )}
              {ex.mistakes && ex.mistakes.length>0 && (
                <div className="mb-2"><div className="text-xs font-semibold text-gray-600 uppercase mb-1">Ошибки</div><ul className="list-disc pl-5 text-sm text-gray-700">{ex.mistakes.map((s,i)=><li key={i}>{s}</li>)}</ul></div>
              )}
              {goal==='support' && ex.progressions && ex.progressions.length>0 && (
                <div className="mb-2">
                  <div className="text-xs font-semibold text-gray-600 uppercase mb-1">Прогрессии</div>
                  <ul className="list-disc pl-5 text-sm text-gray-700">{ex.progressions.map(pid => <li key={pid}>{EX_LOOKUP[pid]?.name || pid}</li>)}</ul>
                </div>
              )}
              {ex.mechanism && <div className="bg-gray-50 border border-gray-100 rounded-xl p-3 text-sm text-gray-800"><b>Зачем:</b> {ex.mechanism}</div>}
              {ex.contraindications && <div className="text-xs text-orange-700 mt-1">⚠ {ex.contraindications}</div>}
              <div className="mt-3">
                <button onClick={()=>onStartTimer(ex.duration, ex.name)} className="px-3 py-2 rounded-lg bg-gray-900 text-white text-sm">Запустить таймер</button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const ReplaceModal = ({ open, onClose, ex, list, onPick }) => {
      if (!open) return null;
      return (
        <div className="modal" role="dialog" aria-modal="true" aria-label="Выбор замены">
          <div className="modal-card p-6">
            <div className="flex items-start justify-between mb-4">
              <h3 className="text-lg font-semibold">Выберите замену для «{ex?.name}»</h3>
              <button className="text-gray-400 hover:text-gray-700" onClick={onClose} aria-label="Закрыть"><Icon name="Close" /></button>
            </div>
            <div className="space-y-3 max-h-[60vh] overflow-auto">
              {list.length===0 && <div className="text-sm text-gray-600">Подходящих аналогов не найдено.</div>}
              {list.map(alt => (
                <button key={alt.id} onClick={()=>onPick(alt)} className="w-full text-left p-3 rounded-xl border border-gray-200 hover:bg-gray-50" aria-label={`Выбрать: ${alt.name}`}>
                  <div className="font-medium text-gray-900">{alt.name}</div>
                  <div className="text-xs text-gray-600 mt-0.5">~ {alt.duration} мин • {alt.tags.join(', ').replace(/(area:|type:|lvl:)/g,'')}</div>
                  <div className="text-xs text-gray-500 mt-1">Почему подходит: {alt.__why}</div>
                </button>
              ))}
            </div>
            <div className="flex justify-end mt-4">
              <button onClick={onClose} className="px-4 py-2 rounded-lg bg-gray-900 text-white">Закрыть</button>
            </div>
          </div>
        </div>
      );
    };

    const GoalModal = ({ open, onSelect, onClose, mode='change' }) => {
      if (!open) return null;
      const allowClose = typeof onClose === 'function' && mode!=='onboarding';
      return (
        <div className="modal" role="dialog" aria-modal="true" aria-label="Выбор цели">
          <div className="modal-card p-6">
            <div className="flex items-start justify-between mb-4">
              <h3 className="text-xl font-semibold">Выберите вашу цель</h3>
              {allowClose && <button className="text-gray-400 hover:text-gray-700" onClick={onClose} aria-label="Закрыть"><Icon name="Close" /></button>}
            </div>
            <div className="space-y-3">
              {GOAL_OPTIONS.map(opt => (
                <button key={opt.id} onClick={()=>onSelect(opt.id)} className="w-full text-left p-4 rounded-xl border border-gray-200 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-300" aria-label={`Выбрать цель ${opt.title}`}>
                  <div className="text-base font-semibold text-gray-900">{opt.title}</div>
                  <div className="text-sm text-gray-500">{opt.description}</div>
                </button>
              ))}
            </div>
            {allowClose && (
              <div className="flex justify-end mt-4">
                <button onClick={onClose} className="px-4 py-2 rounded-lg bg-gray-900 text-white">Отмена</button>
              </div>
            )}
          </div>
        </div>
      );
    };

    const ActivityCard = ({ title, icon, color, items, duration, onReplaceItem, onStartTimer, doneState={}, onToggleDone, idPrefix, goal }) => {
      const colorClass = color==='purple'?'text-purple-600':color==='orange'?'text-orange-600':color==='green'?'text-green-600':'text-blue-600';
      return (
        <div className="bg-white rounded-3xl card flex flex-col">
          <div className="p-6">
            <div className="flex items-center justify-between mb-5">
              <div className="flex items-center">
                <Icon name={icon} className={"w-8 h-8 "+colorClass+" mr-3"} />
                <h3 className="text-xl font-semibold text-gray-900">{title}</h3>
              </div>
              <div className="text-xs text-gray-500">цель ~{duration} мин</div>
            </div>
          </div>
          <div className="border-t border-gray-100">
            {items && items.length>0 ? items.map(ex=>{
              const exKey = `${idPrefix}:${ex.id}`;
              return (
                <ExerciseItem
                  key={ex.id}
                  ex={ex}
                  onReplace={()=>onReplaceItem(ex)}
                  onStartTimer={onStartTimer}
                  done={!!doneState[exKey]}
                  onToggleDone={()=>onToggleDone(exKey)}
                  goal={goal}
                />
              );
            }) : <div className="p-6 text-sm text-gray-600">Без конкретных упражнений сегодня.</div>}
          </div>
        </div>
      );
    };

    // ---------- RPE modal ----------
    const RPEModal = ({ open, onClose, value, onChange, painAreas, setPainAreas }) => {
      if (!open) return null;
      const normalizedPainAreas = normalizePainAreas(painAreas);
      const toggleArea = a => setPainAreas(prev => {
        const list = normalizePainAreas(prev);
        return list.includes(a) ? list.filter(x=>x!==a) : [...list,a];
      });
      return (
        <div className="modal" role="dialog" aria-modal="true" aria-label="Самочувствие">
          <div className="modal-card p-6">
            <div className="flex items-start justify-between mb-4">
              <h3 className="text-xl font-semibold">Как самочувствие перед занятием?</h3>
              <button className="text-gray-400 hover:text-gray-700" onClick={onClose} aria-label="Закрыть"><Icon name="Close" /></button>
            </div>
            <div className="space-y-4">
              <div>
                <label htmlFor="rpe" className="text-sm font-medium text-gray-700">Усталость (RPE)</label>
                <div aria-live="polite" className="text-sm text-gray-600 mt-1">Значение: <b>{value}</b></div>
                <input id="rpe" type="range" min="0" max="10" value={value} onChange={e=>onChange(+e.target.value)} className="w-full" aria-valuemin={0} aria-valuemax={10} aria-valuenow={value} aria-label="Уровень усталости по шкале от 0 до 10"/>
                <div className="flex justify-between text-xs text-gray-500"><span>0 лёгкость</span><span>10 изнеможение</span></div>
              </div>
              <div>
                <div className="text-sm font-medium text-gray-700 mb-2">Есть чувствительность/боль?</div>
                <div className="flex flex-wrap gap-2">
                  {['шея','плечо','таз/спина','задняя цепь','стопа/голеностоп'].map(a=>(
                    <button key={a} onClick={()=>toggleArea(a)} className={`px-3 py-1.5 rounded-lg border ${normalizedPainAreas.includes(a)?'bg-red-50 border-red-300 text-red-700':'bg-white border-gray-200 text-gray-700'}`} aria-pressed={normalizedPainAreas.includes(a)}>{a}</button>
                  ))}
                </div>
                <div className="text-xs text-gray-500 mt-2">Мы подстроим сложность и исключим конфликтующие упражнения.</div>
              </div>
              <div className="flex justify-end gap-2">
                <button onClick={onClose} className="px-4 py-2 rounded-lg bg-gray-900 text-white">Сохранить</button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ---------- Generator & App ----------
    const WEEKLY_DUR = {
      1:{1:{walking:60,stretching:25,meditation:12,exercises:15},2:{walking:60,stretching:30,meditation:15,exercises:12},3:{walking:75,stretching:25,meditation:18,exercises:18},4:{walking:60,stretching:35,meditation:15,exercises:12},5:{walking:75,stretching:40,meditation:20,exercises:20},6:{walking:90,stretching:45,meditation:25,exercises:18},7:{walking:75,stretching:30,meditation:20,exercises:0}},
      2:{1:{walking:75,stretching:35,meditation:20,exercises:22},2:{walking:80,stretching:40,meditation:25,exercises:18},3:{walking:90,stretching:35,meditation:30,exercises:25},4:{walking:75,stretching:45,meditation:22,exercises:18},5:{walking:90,stretching:50,meditation:30,exercises:28},6:{walking:90,stretching:55,meditation:35,exercises:22},7:{walking:80,stretching:40,meditation:25,exercises:0}}
    };

    // walking presets (text steps; timer uses total minutes)
    const WALK_PRESETS = [
      { id:'intervals', name:'Интервалы дыхания', how:[ '3 мин обычный шаг', '1 мин длинный выдох' ], note:'Повторить 6 раз' },
      { id:'hills', name:'Два подъёма', how:[ '5–8 мин разминка', '2 подъёма по 2–4 мин в разговорном темпе' ], note:'Между подъёмами — 3–4 мин восстановление' },
      { id:'quest', name:'Фото‑квест', how:[ 'Найдите 3 зелёных объекта', 'Найдите 2 контрастных цвета', 'Зафиксируйте ровное дыхание' ], note:'Темп — комфортный' }
    ];

    function generatePlan({ week, day, theme, rpe, pain, lastAreas, rpeLowStreak, profile }){
      const goal = profile?.goal || 'prevent';
      const goalSettings = GOAL_CONFIG[goal] || GOAL_CONFIG.prevent;
      const equipment = profile?.equipment ? { ...EQUIPMENT_DEFAULTS, ...profile.equipment } : { ...EQUIPMENT_DEFAULTS };
      const seed = `${APP.seed}|cycle:${APP.cycle}|w${week}d${day}`;
      const rng = rngFrom(seed);

      // Adjust targets by RPE
      const base = WEEKLY_DUR[week][day];
      const factor = rpe>=7 ? 0.75 : (rpeLowStreak>=2 && rpe<=3 ? 1.1 : 1.0);
      const goalFactor = goalSettings?.factor ?? 1.0;
      const tgt = {
        walking: Math.round(base.walking*factor*goalFactor),
        stretching: Math.round(base.stretching*factor*goalFactor),
        meditation: Math.round(base.meditation*(rpe>=7?1.1:1.0)*goalFactor), // чуть больше дыхания при высокой усталости
        exercises: Math.round(base.exercises*(rpe>=7?0.7:1.0)*goalFactor)
      };

      // candidates
      let st = filterByPools(EX_STRETCH, theme.pools);
      st = filterByGoal(st, goal);
      st = filterByEquipment(st, equipment);
      st = filterByPain(st, pain);
      st = filterByLevelRPE(st, rpe, rpeLowStreak);

      let lf = filterByPools(EX_LFK, theme.pools.concat(['area:core','area:balance']));
      lf = filterByGoal(lf, goal);
      lf = filterByEquipment(lf, equipment);
      lf = excludeStrengthIfHighRPE(lf, rpe, goal);
      lf = filterByPain(lf, pain);
      lf = filterByLevelRPE(lf, rpe, rpeLowStreak);

      // meditation candidates
      let md = filterByGoal(EX_MEDIT.slice(), goal);
      md = filterByEquipment(md, equipment);
      if (rpe>=7) md = md.filter(ex => ['type:breath','type:awareness'].includes(typeOf(ex)));
      const medList = packByMinutes(rng, md, ['type:breath','type:awareness'], tgt.meditation, lastAreas, { tolerance: 0.15 });

      // pack stretch & lfk by minutes with diversity
      const stTypesPref = theme.include.filter(t=>['type:mobility','type:neuro','type:stability'].includes(t));
      const stList = packByMinutes(rng, st, stTypesPref.length?stTypesPref:['type:mobility','type:neuro','type:stability'], tgt.stretching, lastAreas, {});

      let lfTypesPref = ['type:stability','type:strength','type:balance'].filter(t => !(rpe>=7 && t==='type:strength'));
      if (goal==='rehab') lfTypesPref = lfTypesPref.filter(t=>t!=='type:strength');
      let lfkList = packByMinutes(rng, lf, lfTypesPref, tgt.exercises, lastAreas, {});

      // Fallback ladder
      function fallbackIfEmpty(list, all, target){
        if (list.length>0) return list;
        // A) relax lastAreas constraint (ignore)
        let cand = all.slice();
        let l = packByMinutes(rng, cand, lfTypesPref, target, [], {});
        if (l.length>0) return l;
        // B) include neighbor pools (already included for LFK)
        // C) drop to lvl:1 only
        cand = all.filter(x => levelOf(x)==='lvl:1');
        l = packByMinutes(rng, cand, ['type:mobility','type:stability','type:balance'], target, [], {});
        return l;
      }
      lfkList = tgt.exercises>0 ? fallbackIfEmpty(lfkList, lf, tgt.exercises) : [];

      // walking preset
      const walking = WALK_PRESETS[Math.floor(rng()*WALK_PRESETS.length)];

      // why today (bullets)
      const typesToday = Array.from(new Set(stList.concat(lfkList).map(typeOf))).map(t=>t.replace('type:',''));
      const bullets = [];
      bullets.push(`Тема: ${theme.title}.`);
      if (goal==='rehab') bullets.push('Цель: реабилитация → только мягкие lvl 1, −25% длительности, без силовых.');
      if (goal==='prevent') bullets.push('Цель: профилактика → баланс мобилити и стабильности, базовые длительности.');
      if (goal==='support') bullets.push('Цель: поддержка формы → +15% к длительности и добавлены прогрессии.');
      if (rpe>=7) bullets.push('Высокая усталость → уменьшили объём, меньше силы, больше мобилити/дыхания.');
      if (rpeLowStreak>=2 && rpe<=3) bullets.push('Низкая усталость последние дни → добавили сложность/объём.');
      if (pain.length) bullets.push(`Исключили нагрузки на: ${pain.join(', ')}.`);
      if (typesToday.length) {
        bullets.push(`Баланс стимулов: ${typesToday.join(' + ')}.`);
      } else {
        bullets.push('Фокус: восстановление/дыхание.');
      }
      bullets.push(`KPI дня: «комфортная осанка»/ROM целевой области без болезненности.`);

      // dominant area by minutes
      const sumByArea = {};
      const add = ex => sumByArea[areaOf(ex)] = (sumByArea[areaOf(ex)]||0) + (ex.duration||0);
      stList.forEach(add); lfkList.forEach(add);
      const primaryArea = Object.entries(sumByArea).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'area:unknown';

      // log usage
      const usedIds = [...stList, ...lfkList, ...medList].map(x=>x.id);
      const oldLog = LS.get('plan.log', []);
      const newLog = [...usedIds, ...oldLog].slice(0,60);
      LS.set('plan.log', newLog);

      return { stList, lfkList, medList, walking, whyBullets: bullets, primaryArea, targets: tgt };
    }

    function buildExerciseKeys(plan){
      if (!plan) return [];
      const keys = [];
      if (plan.walking) keys.push(`walk:${plan.walking.id||'session'}`);
      (plan.stList||[]).forEach(ex=>keys.push(`st:${ex.id}`));
      (plan.medList||[]).forEach(ex=>keys.push(`med:${ex.id}`));
      (plan.lfkList||[]).forEach(ex=>keys.push(`lfk:${ex.id}`));
      return keys;
    }

    function App(){
      const [section,setSection]=useState('program');
      const [profile,setProfile]=useState(()=>{
        const raw = LS.get('user.profile', null);
        if (raw){
          return {
            goal: raw.goal || 'prevent',
            startDate: raw.startDate || new Date().toISOString().slice(0,10),
            equipment: { ...EQUIPMENT_DEFAULTS, ...(raw.equipment||{}) }
          };
        }
        return null;
      });
      const [showOnboarding,setShowOnboarding]=useState(()=>!LS.get('user.profile', null));
      const [showGoalModal,setShowGoalModal]=useState(false);
      const [week,setWeek]=useState(1);
      const [day,setDay]=useState(1);
      const [rpe,setRpe]=useState(LS.get('user.rpe', 4));
      const [rpeHistory,setRpeHistory]=useState(LS.get('user.rpeHistory', [])); // last N
      const [painAreas,setPainAreas]=useState(()=>normalizePainAreas(LS.get('user.pain', [])));
      const [showRPE,setShowRPE]=useState(false);
      const [plan,setPlan]=useState(LS.get('plan.v2', {}));
      const [history,setHistory]=useState(LS.get('generator.history.v2', [])); // [{w,d,area,minutes}...]
      const [doneMap,setDoneMap]=useState(LS.get('progress.done', {}));
      const [completionHistory,setCompletionHistory]=useState(LS.get('progress.history', []));
      const autoAdjustRef = useRef(null);

      useEffect(()=>{ if (profile) LS.set('user.profile', profile); },[profile]);

      useEffect(()=>LS.set('user.rpe', rpe),[rpe]);
      useEffect(()=>LS.set('user.pain', painAreas),[painAreas]);
      useEffect(()=>LS.set('user.rpeHistory', rpeHistory),[rpeHistory]);
      useEffect(()=>LS.set('plan.v2', plan),[plan]);
      useEffect(()=>LS.set('generator.history.v2', history),[history]);
      useEffect(()=>LS.set('progress.done', doneMap),[doneMap]);
      useEffect(()=>LS.set('progress.history', completionHistory),[completionHistory]);

      // derive low streak
      const lowStreak = (rpeHistory.slice(0,2).every(x=>x<=3) && rpe<=3) ? 2 : (rpeHistory[0]<=3 && rpe<=3 ? 1 : 0);

      const theme = THEMES.find(t=>t.dow===day);
      const key = `w${week}d${day}`;
      const goalId = profile?.goal || 'prevent';
      const goalMeta = GOAL_CONFIG[goalId];
      const equipmentState = profile?.equipment ? { ...EQUIPMENT_DEFAULTS, ...profile.equipment } : { ...EQUIPMENT_DEFAULTS };

      const dayPlan = plan[key];
      const exerciseKeys = useMemo(()=>buildExerciseKeys(dayPlan),[dayPlan]);
      const doneStateForDay = doneMap[key]||{};
      const dayDone = exerciseKeys.filter(k=>doneStateForDay[k]).length;
      const dayTotal = exerciseKeys.length;
      const dayPercent = dayTotal ? Math.round((dayDone/dayTotal)*100) : 0;
      const walkingKey = dayPlan ? `walk:${dayPlan.walking.id||'session'}` : null;
      const walkingDone = walkingKey ? !!doneStateForDay[walkingKey] : false;

      const handleGoalSelect = useCallback((nextGoal)=>{
        const today = new Date().toISOString().slice(0,10);
        setProfile(prev => {
          const baseEquip = prev?.equipment ? { ...EQUIPMENT_DEFAULTS, ...prev.equipment } : { ...EQUIPMENT_DEFAULTS };
          return { goal: nextGoal, startDate: today, equipment: baseEquip };
        });
        setPlan(()=>({}));
        setShowOnboarding(false);
        setShowGoalModal(false);
      },[setPlan, setShowGoalModal, setShowOnboarding]);

      const handleEquipmentToggle = useCallback((equipKey)=>{
        if (!profile) return;
        setProfile(prev => {
          const prevEquip = { ...EQUIPMENT_DEFAULTS, ...(prev?.equipment||{}) };
          prevEquip[equipKey] = !prevEquip[equipKey];
          return { ...prev, equipment: prevEquip };
        });
        setPlan(()=>({}));
      },[profile, setPlan, setProfile]);

      const toggleDone = useCallback((exerciseKey)=>{
        setDoneMap(prev => {
          const prevDay = prev[key]||{};
          const nextDay = { ...prevDay, [exerciseKey]: !prevDay[exerciseKey] };
          return { ...prev, [key]: nextDay };
        });
      },[key]);

      useEffect(()=>{
        if (!dayPlan) return;
        setDoneMap(prev => {
          const currentDay = { ...(prev[key]||{}) };
          let changed = false;
          exerciseKeys.forEach(k=>{
            if (!(k in currentDay)){ currentDay[k]=false; changed=true; }
          });
          Object.keys(currentDay).forEach(k=>{
            if (!exerciseKeys.includes(k)){ delete currentDay[k]; changed=true; }
          });
          if (!changed) return prev;
          return { ...prev, [key]: currentDay };
        });
      },[dayPlan, exerciseKeys, key]);

      useEffect(()=>{
        if (!dayPlan) return;
        const total = exerciseKeys.length;
        const doneCount = exerciseKeys.filter(k=>doneStateForDay[k]).length;
        const percent = total ? Math.round((doneCount/total)*100) : 0;
        const dateKey = new Date().toISOString().slice(0,10);
        setCompletionHistory(prev => {
          const existing = prev.find(entry => entry.date===dateKey && entry.planKey===key);
          if (existing && existing.done===doneCount && existing.total===total) return prev;
          const others = prev.filter(entry => !(entry.date===dateKey && entry.planKey===key));
          const updated = [{ date: dateKey, planKey: key, done: doneCount, total, percent }, ...others];
          return updated.slice(0,30);
        });
      },[dayPlan, exerciseKeys, doneMap, doneStateForDay, key]);

      const last7Days = useMemo(()=>{
        const now = new Date();
        return completionHistory
          .filter(entry => {
            if (!entry.date) return false;
            const dt = new Date(`${entry.date}T00:00:00`);
            const diff = (now - dt) / 86400000;
            return diff >= 0 && diff < 7;
          })
          .sort((a,b)=> new Date(b.date) - new Date(a.date));
      },[completionHistory]);

      const weeklyStats = useMemo(()=>{
        const todayKey = new Date().toISOString().slice(0,10);
        const relevant = last7Days.filter(entry => {
          if (!entry || !entry.total) return false;
          if (entry.date === todayKey && (entry.done||0) < entry.total) return false;
          return true;
        });
        const totalDone = relevant.reduce((acc,e)=>acc+(e.done||0),0);
        const totalPlanned = relevant.reduce((acc,e)=>acc+(e.total||0),0);
        const percent = totalPlanned ? Math.round((totalDone/totalPlanned)*100) : 0;
        return { done: totalDone, total: totalPlanned, percent };
      },[last7Days]);
      const weeklyBarColor = weeklyStats.percent>=70?'bg-green-500':weeklyStats.percent>=40?'bg-amber-400':'bg-rose-400';

      const dailyAggregated = useMemo(()=>{
        const map = new Map();
        completionHistory.forEach(entry => {
          if (!entry || !entry.date) return;
          if (!map.has(entry.date)){
            map.set(entry.date, { date: entry.date, done: 0, total: 0 });
          }
          const agg = map.get(entry.date);
          agg.done += entry.done || 0;
          agg.total += entry.total || 0;
        });
        return Array.from(map.values()).sort((a,b)=> new Date(b.date) - new Date(a.date));
      },[completionHistory]);

      const overallStats = useMemo(()=>{
        if (dailyAggregated.length===0) return { percent:0, done:0, total:0 };
        const relevant = dailyAggregated.filter(entry => entry.total>0);
        const done = relevant.reduce((acc,e)=>acc+(e.done||0),0);
        const total = relevant.reduce((acc,e)=>acc+(e.total||0),0);
        const percent = total ? Math.round((done/total)*100) : 100;
        return { percent, done, total };
      },[dailyAggregated]);

      const streak = useMemo(()=>{
        if (dailyAggregated.length===0) return 0;
        const map = new Map(dailyAggregated.map(entry => [entry.date, entry]));
        const now = new Date();
        let count = 0;
        for (let i=0; i<365; i++){
          const dt = new Date(now);
          dt.setDate(now.getDate()-i);
          const keyDate = dt.toISOString().slice(0,10);
          const info = map.get(keyDate);
          if (!info) break;
          const completed = info.total>0 ? info.done>=info.total : true;
          if (completed){
            count++;
          } else {
            break;
          }
        }
        return count;
      },[dailyAggregated]);

      const daysFromStart = useMemo(()=>{
        if (!profile?.startDate) return 0;
        const start = new Date(`${profile.startDate}T00:00:00`);
        if (Number.isNaN(start.getTime())) return 0;
        const now = new Date();
        const diff = Math.floor((now - start) / 86400000);
        return diff>=0 ? diff+1 : 0;
      },[profile?.startDate]);

      useEffect(()=>{
        if (!dayPlan) return;
        if (weeklyStats.total > 0 && weeklyStats.percent < 40 && rpe > 0){
          const tag = `${key}-${weeklyStats.percent}`;
          if (autoAdjustRef.current !== tag){
            autoAdjustRef.current = tag;
            setRpe(prev => Math.max(0, prev-1));
          }
        } else if (weeklyStats.percent >= 40 || weeklyStats.total === 0) {
          autoAdjustRef.current = null;
        }
      },[dayPlan, key, weeklyStats, rpe]);

      const formatDate = useCallback((dateStr)=>{
        try{
          return new Date(`${dateStr}T00:00:00`).toLocaleDateString('ru-RU',{ weekday:'short', day:'numeric', month:'short' });
        }catch{return dateStr;}
      },[]);

      // Generate in effect if missing or when RPE/pain changes
      useEffect(()=>{
        if (!profile) return;
        const lastAreas = history.slice(0,3).map(h=>h.area);
        const gen = generatePlan({ week, day, theme, rpe, pain: normalizePainAreas(painAreas), lastAreas, rpeLowStreak: lowStreak, profile });
        setPlan(prev => ({ ...prev, [key]: gen }));
        // push history
        const minutes = Object.values(gen.targets).reduce((a,b)=>a+b,0);
        setHistory(prev => [{ w:week, d:day, area: gen.primaryArea, minutes }, ...prev].slice(0,5));
        // update rpe history
        setRpeHistory(prev => [rpe, ...prev].slice(0,7));
      // eslint-disable-next-line
      }, [profile, week, day, rpe, JSON.stringify(painAreas)]);

      // Replace flow
      const [modal,setModal]=useState({open:false, listName:null, ex:null, candidates:[]});
      const openReplace = (listName, ex) => {
        const dataMap = { stList: EX_STRETCH, lfkList: EX_LFK, medList: EX_MEDIT };
        const all = dataMap[listName]||[];
        const goal = profile?.goal || 'prevent';
        const eq = profile?.equipment ? { ...EQUIPMENT_DEFAULTS, ...profile.equipment } : { ...EQUIPMENT_DEFAULTS };
        // candidates: prefer same type & area; фильтры цели/оборудования/боли
        let cand = all.filter(c => c.id!==ex.id);
        cand = filterByGoal(cand, goal);
        cand = filterByEquipment(cand, eq);
        cand = filterByPain(cand, painAreas);
        cand = filterByLevelRPE(cand, rpe, lowStreak);
        if (listName==='lfkList') cand = excludeStrengthIfHighRPE(cand, rpe, goal);
        // rank by match + rarity
        cand = rankAlternatives(ex, cand);
        // guarantee at least 2: if empty, relax to same type only, then lvl:1 any
        if (cand.length<2){
          let extra = all.filter(c => c.id!==ex.id && typeOf(c)===typeOf(ex));
          extra = filterByGoal(extra, goal);
          extra = filterByEquipment(extra, eq);
          extra = filterByPain(extra, painAreas);
          extra = filterByLevelRPE(extra, rpe, lowStreak);
          extra = rankAlternatives(ex, extra);
          cand = [...cand, ...extra].filter((v,i,a)=>a.findIndex(x=>x.id===v.id)===i);
        }
        if (cand.length<2){
          let extra = all.filter(c => c.id!==ex.id && levelOf(c)==='lvl:1');
          extra = filterByGoal(extra, goal);
          extra = filterByEquipment(extra, eq);
          extra = filterByPain(extra, painAreas);
          extra = filterByLevelRPE(extra, rpe, lowStreak);
          extra = rankAlternatives(ex, extra);
          cand = [...cand, ...extra].filter((v,i,a)=>a.findIndex(x=>x.id===v.id)===i);
        }
        cand = cand.slice(0,6);
        setModal({open:true, listName, ex, candidates:cand});
      };
      const pickReplace = (alt) => {
        const p = plan[key];
        const arr = p[modal.listName].slice();
        const idx = arr.findIndex(x=>x.id===modal.ex.id);
        if (idx>=0){
          arr[idx]=alt;
          const updated = { ...p, [modal.listName]: arr };
          setPlan(prev => ({ ...prev, [key]: updated }));
          // log usage
          const oldLog = LS.get('plan.log', []);
          LS.set('plan.log', [alt.id, ...oldLog].slice(0,60));
        }
        setModal({open:false, listName:null, ex:null, candidates:[]});
      };

      const timer = useTimer();

      if (!dayPlan){
        return (
          <>
            <div className="min-h-screen">
              <Segmented active={section} onChange={setSection} />
              <div className="max-w-3xl mx-auto px-4 py-12">
                <div className="bg-white rounded-2xl p-8 border border-gray-100 text-center">
                  <div className="text-lg">Готовим план на сегодня…</div>
                  <div className="text-sm text-gray-500 mt-1">Учитываем тему, усталость и историю последних дней</div>
                </div>
              </div>
            </div>
            <GoalModal open={showGoalModal} onSelect={handleGoalSelect} onClose={()=>setShowGoalModal(false)} />
            <GoalModal open={(showOnboarding || !profile)} onSelect={handleGoalSelect} mode="onboarding" />
          </>
        );
      }

      const why = dayPlan.whyBullets;
      const showLfkCard = (dayPlan.targets?.exercises ?? 0) > 0;

      return (
        <div className="min-h-screen page show">
          <Segmented active={section} onChange={setSection} />
          {section==='program' && (
            <div className="max-w-7xl mx-auto px-4 py-8">
              <div className="bg-white border border-gray-100 rounded-2xl p-5 subtle mb-4">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="text-sm text-gray-500 uppercase font-medium">Фокус дня</div>
                    <div className="text-xl font-semibold">{THEMES.find(t=>t.dow===day).title} <span className="text-gray-400 text-sm font-normal ml-2">Неделя {week===1?'A':'B'}</span></div>
                    <ul className="mt-2 list-disc pl-5 text-sm text-gray-700 space-y-1">
                      {why.map((w,i)=><li key={i}>{w}</li>)}
                    </ul>
                    <div className="mt-4 bg-gray-50 border border-gray-100 rounded-xl p-3 flex items-center justify-between">
                      <div>
                        <div className="text-xs text-gray-500 uppercase font-medium tracking-wide">Прогресс дня</div>
                        <div className="text-sm text-gray-600">{dayDone} из {dayTotal} упражнений</div>
                      </div>
                      <div className={`text-2xl font-semibold ${dayPercent>=70?'text-green-600':dayPercent>=40?'text-amber-500':'text-rose-500'}`}>{dayPercent}%</div>
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <button onClick={()=>setShowRPE(true)} className="px-3 py-1.5 rounded-lg border border-gray-200 text-gray-700 text-sm" aria-label="Настроить план по самочувствию">Настроить (RPE)</button>
                    <button onClick={()=>{ APP.cycle=(APP.cycle||1)+1; LS.set('app.meta', APP); setPlan(p=>{ const np={...p}; delete np[key]; return np; }); }} className="px-3 py-1.5 rounded-lg border border-gray-200 text-gray-700 text-sm flex items-center gap-1" title="Сгенерировать альтернативу на этот день"><Icon name="Shuffle" className="w-4 h-4" /> Альтернатива</button>
                  </div>
                </div>
              </div>

              {/* Week/Day selectors */}
              <div className="flex items-center justify-between mb-6">
                <div className="flex gap-2">
                  {[1,2].map(w=>(
                    <button key={w} onClick={()=>setWeek(w)} className={"tap w-12 h-12 rounded-lg "+(week===w?'bg-gray-900 text-white':'bg-white text-gray-700 border border-gray-200 hover:bg-gray-50')} aria-pressed={week===w}>{w===1?'A':'B'}</button>
                  ))}
                </div>
                <div className="md:hidden flex gap-2 overflow-x-auto -mx-4 px-4 pb-2 hide-scrollbar">
                  {[1,2,3,4,5,6,7].map(dn=>(
                    <button key={dn} onClick={()=>setDay(dn)} className={"tap min-w-[92px] px-3 py-2 rounded-lg text-center "+(day===dn?'bg-gray-900 text-white':'bg-white text-gray-700 border border-gray-200')} aria-pressed={day===dn}>
                      <div className="font-medium text-sm">{['ПН','ВТ','СР','ЧТ','ПТ','СБ','ВС'][dn-1]}</div>
                      <div className="text-[11px] opacity-75">День {dn}</div>
                    </button>
                  ))}
                </div>
                <div className="hidden md:grid grid-cols-7 gap-2">
                  {[1,2,3,4,5,6,7].map(dn=>(
                    <button key={dn} onClick={()=>setDay(dn)} className={"p-3 rounded-lg text-center border "+(day===dn?'bg-gray-900 text-white border-transparent':'bg-white text-gray-700 border-gray-200 hover:bg-gray-50')} aria-pressed={day===dn}>
                      <div className="font-medium">{['ПН','ВТ','СР','ЧТ','ПТ','СБ','ВС'][dn-1]}</div>
                      <div className="text-xs opacity-70">День {dn}</div>
                    </button>
                  ))}
                </div>
              </div>

              {/* Activities */}
              <div className="grid md:grid-cols-2 gap-6">
                {/* Walking with presets */}
                <div className="bg-white rounded-3xl card">
                  <div className="p-6">
                    <div className="flex items-center justify-between mb-5">
                      <div className="flex items-center">
                        <Icon name="Heart" className="w-8 h-8 text-blue-600 mr-3" />
                        <h3 className={`text-xl font-semibold ${walkingDone?'text-gray-400 line-through':'text-gray-900'}`}>Прогулка</h3>
                      </div>
                      <div className="flex items-center gap-4">
                        <div className="text-xs text-gray-500 text-right">цель ~{dayPlan.targets.walking} мин</div>
                        <div className="flex flex-col items-center">
                          <button onClick={()=>walkingKey && toggleDone(walkingKey)} className={`btn-done ${walkingDone?'is-on':''}`} aria-pressed={walkingDone} aria-label={walkingDone?'Отметить прогулку как невыполненную':'Отметить прогулку как выполненную'}>
                            <Icon name="Check" className={`w-5 h-5 ${walkingDone?'text-white':'text-gray-400'}`} />
                          </button>
                          <span className="text-[11px] text-gray-500 mt-1">Выполнено</span>
                        </div>
                      </div>
                    </div>
                    <div className="bg-gray-50 border border-gray-100 rounded-xl p-3">
                      <div className="text-sm font-medium text-gray-800 mb-1">Пресет: {dayPlan.walking.name}</div>
                      <ul className="list-disc pl-5 text-sm text-gray-700">
                        {dayPlan.walking.how.map((s,i)=><li key={i}>{s}</li>)}
                      </ul>
                      <div className="text-xs text-gray-500 mt-1">{dayPlan.walking.note}</div>
                      <div className="mt-3 flex items-center gap-3">
                        <button onClick={()=>timer.start(Math.max(10, Math.min(120, dayPlan.targets.walking)), 'Прогулка')} className="px-3 py-2 rounded-lg bg-gray-900 text-white text-sm">Старт таймера</button>
                        {walkingDone && <span className="text-xs text-green-600">Отлично! Продолжай движение.</span>}
                      </div>
                    </div>
                  </div>
                </div>

                <ActivityCard title="Растяжка" icon="Circle" color="purple" items={dayPlan.stList} duration={dayPlan.targets.stretching} onReplaceItem={(ex)=>openReplace('stList', ex)} onStartTimer={(min,label)=>timer.start(min,label)} doneState={doneStateForDay} onToggleDone={toggleDone} idPrefix="st" goal={goalId} />
                <ActivityCard title="Медитация" icon="User" color="orange" items={dayPlan.medList} duration={dayPlan.targets.meditation} onReplaceItem={(ex)=>openReplace('medList', ex)} onStartTimer={(min,label)=>timer.start(min,label)} doneState={doneStateForDay} onToggleDone={toggleDone} idPrefix="med" goal={goalId} />
                {showLfkCard && (
                  <ActivityCard title="ЛФК" icon="Activity" color="green" items={dayPlan.lfkList} duration={dayPlan.targets.exercises} onReplaceItem={(ex)=>openReplace('lfkList', ex)} onStartTimer={(min,label)=>timer.start(min,label)} doneState={doneStateForDay} onToggleDone={toggleDone} idPrefix="lfk" goal={goalId} />
                )}
              </div>
            </div>
          )}

          {section==='overview' && (
            <div className="max-w-7xl mx-auto px-4 py-10">
              <h1 className="text-3xl font-semibold mb-4">Вариативная программа</h1>
              <p className="text-gray-600 mb-6">Темы по дням, недели A/B, генерация по минутам с учётом усталости, боли и истории.</p>
              <div className="bg-white rounded-2xl border border-gray-100 p-5 subtle">
                <div className="text-sm text-gray-600">Принципы:</div>
                <ul className="list-disc pl-6 text-sm text-gray-800 mt-2 space-y-1">
                  <li>Не повторяем доминирующую область два дня подряд.</li>
                  <li>Подбираем набор под целевые минуты с допуском ±10%.</li>
                  <li>RPE влияет на объём и тип стимулов; боль исключает конфликтующие области.</li>
                </ul>
              </div>
            </div>
          )}

          {section==='progress' && (
            <div className="max-w-7xl mx-auto px-4 py-10">
              <h1 className="text-3xl font-semibold mb-4">Прогресс</h1>
              <div className="grid gap-4">
                <div className="bg-white rounded-2xl border border-gray-100 p-5 subtle">
                  <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                      <div className="text-sm text-gray-500 uppercase font-medium">Последние 7 дней</div>
                      <div className="text-4xl font-semibold text-gray-900 mt-1">{weeklyStats.percent}%</div>
                      <div className="text-xs text-gray-500 mt-1">{weeklyStats.done} из {weeklyStats.total} отмеченных упражнений</div>
                    </div>
                    <div className="flex-1 w-full">
                      <div className="w-full h-3 bg-gray-200 rounded-full overflow-hidden" aria-hidden="true">
                        <div className={`${weeklyBarColor} h-full transition-all duration-500`} style={{ width: Math.min(weeklyStats.percent,100)+'%' }} />
                      </div>
                      <div className="text-xs text-gray-400 mt-1">Цель — удерживать 70% и выше.</div>
                    </div>
                  </div>
                  <div className="mt-5">
                    {last7Days.length>0 ? (
                      <div className="grid gap-3 md:grid-cols-2">
                        {last7Days.map(entry => (
                          <div key={entry.date+entry.planKey} className="p-3 border border-gray-100 rounded-xl flex items-center justify-between">
                            <div>
                              <div className="text-sm font-medium text-gray-800">{formatDate(entry.date)}</div>
                              <div className="text-xs text-gray-500">{entry.done} из {entry.total}</div>
                            </div>
                            <div className="text-lg font-semibold text-gray-900">{entry.percent}%</div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div className="text-sm text-gray-600">Пока нет данных. Отмечайте упражнения чекбоксом «Выполнено», чтобы видеть динамику.</div>
                    )}
                  </div>
                  <div className="text-xs text-gray-500 mt-4">Если за завершённые дни недели выполнено меньше 40% упражнений, при следующей генерации программа автоматически снизит RPE на 1 для мягкой адаптации.</div>
                </div>

                <div className="bg-white rounded-2xl border border-gray-100 p-5 subtle">
                  <div className="text-sm text-gray-600">Последние дни (доминирующие области):</div>
                  <div className="flex gap-2 mt-2 flex-wrap">
                    {history.map((h,i)=>(<span key={i} className="px-2 py-1 rounded bg-gray-100 text-gray-700 text-xs">{h.area.replace('area:','')}</span>))}
                  </div>
                  <div className="text-xs text-gray-500 mt-3">В Итерации 3 добавим аналитику по темам и влияние RPE.</div>
                </div>
              </div>
            </div>
          )}

          {section==='profile' && (
            <div className="max-w-4xl mx-auto px-4 py-10">
              <h1 className="text-3xl font-semibold mb-4">Профиль</h1>
              {!profile ? (
                <div className="bg-white rounded-2xl border border-gray-100 p-6 subtle">
                  <p className="text-gray-600">Чтобы персонализировать программу, выберите цель.</p>
                  <button onClick={()=>setShowOnboarding(true)} className="mt-4 px-4 py-2 rounded-lg bg-gray-900 text-white">Выбрать цель</button>
                </div>
              ) : (
                <div className="grid gap-4">
                  <div className="bg-white rounded-2xl border border-gray-100 p-6 subtle">
                    <div className="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                      <div>
                        <div className="text-sm text-gray-500 uppercase font-medium">Цель</div>
                        <div className="text-2xl font-semibold text-gray-900 mt-1">{goalMeta?.title || 'Персонализация'}</div>
                        <div className="text-sm text-gray-500 mt-1">{goalMeta?.description}</div>
                        <div className="text-xs text-gray-400 mt-2">Старт программы: {profile.startDate}</div>
                      </div>
                      <button onClick={()=>setShowGoalModal(true)} className="px-4 py-2 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-50">Изменить цель</button>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-6">
                      <div className="bg-gray-50 border border-gray-100 rounded-xl p-4">
                        <div className="text-xs text-gray-500 uppercase tracking-wide">Дни с момента старта</div>
                        <div className="text-2xl font-semibold text-gray-900 mt-1">{daysFromStart || '—'}</div>
                        <div className="text-xs text-gray-500">дней в программе</div>
                      </div>
                      <div className="bg-gray-50 border border-gray-100 rounded-xl p-4">
                        <div className="text-xs text-gray-500 uppercase tracking-wide">Общий % выполнения</div>
                        <div className="text-2xl font-semibold text-gray-900 mt-1">{overallStats.percent}%</div>
                        <div className="text-xs text-gray-500">на основе отмеченных упражнений</div>
                      </div>
                      <div className="bg-gray-50 border border-gray-100 rounded-xl p-4">
                        <div className="text-xs text-gray-500 uppercase tracking-wide">Streak (дни подряд)</div>
                        <div className="text-2xl font-semibold text-gray-900 mt-1">{streak}</div>
                        <div className="text-xs text-gray-500">подряд с выполнением</div>
                      </div>
                    </div>
                  </div>

                  <div className="bg-white rounded-2xl border border-gray-100 p-6 subtle">
                    <div className="text-sm font-semibold text-gray-700">Доступное оборудование</div>
                    <div className="flex flex-col sm:flex-row sm:items-center gap-3 mt-4">
                      {['mat','band','wall'].map(eq => (
                        <label key={eq} className="flex items-center gap-2 text-sm text-gray-700">
                          <input type="checkbox" className="w-4 h-4" checked={!!equipmentState[eq]} onChange={()=>handleEquipmentToggle(eq)} />
                          <span>{EQUIPMENT_LABELS[eq]}</span>
                        </label>
                      ))}
                    </div>
                    <div className="text-xs text-gray-500 mt-3">Мы подбираем только упражнения, которые можно выполнить с доступным оборудованием.</div>
                  </div>
                </div>
              )}
            </div>
          )}

          <RPEModal open={showRPE} onClose={()=>setShowRPE(false)} value={rpe} onChange={setRpe} painAreas={painAreas} setPainAreas={setPainAreas} />
          <ReplaceModal open={modal.open} onClose={()=>setModal({open:false})} ex={modal.ex} list={modal.candidates} onPick={pickReplace} />
          <GoalModal open={showGoalModal} onSelect={handleGoalSelect} onClose={()=>setShowGoalModal(false)} />
          <GoalModal open={(showOnboarding || !profile)} onSelect={handleGoalSelect} mode="onboarding" />

          {/* Timer UI */}
          {timer.state.target>0 && !timer.state.collapsed && (
            <div className="timer-sheet p-4 md:p-6" aria-live="polite">
              <button className="absolute right-3 top-3 text-gray-400 hover:text-gray-700" aria-label="Закрыть таймер" onClick={timer.close}><Icon name="Close" /></button>
              <div className="text-center">
                <div className="text-sm text-gray-500 mb-1">{timer.state.label || 'Сессия'}</div>
                <div className="text-4xl font-extralight mb-3 text-gray-900">{fmt(timer.state.time)}</div>
                <div className="flex items-center justify-center gap-3">
                  <button onClick={timer.pause} className="tap bg-gray-900 text-white px-5 py-3 rounded-xl">{timer.state.run?'Пауза':'Старт'}</button>
                  <button onClick={timer.reset} className="tap bg-gray-200 text-gray-700 px-5 py-3 rounded-xl">Сброс</button>
                  <button onClick={timer.collapse} className="tap bg-white border border-gray-200 text-gray-700 px-5 py-3 rounded-xl">Свернуть</button>
                </div>
              </div>
            </div>
          )}
          {timer.state.target>0 && timer.state.collapsed && (
            <button className="timer-pill flex items-center gap-2" onClick={timer.expand} title="Развернуть таймер">
              <Icon name={timer.state.run?'Pause':'Play'} className="w-5 h-5" />
              <span className="text-sm font-medium">{fmt(timer.state.time)}</span>
            </button>
          )}
        </div>
      );
    }

    function Root(){
      return <TimerProvider><App/></TimerProvider>
    }

    // Mount
    class ErrorBoundary extends React.Component {
      constructor(p){ super(p); this.state={hasError:false}; }
      static getDerivedStateFromError(){ return {hasError:true}; }
      componentDidCatch(e,i){ console.error("Uncaught error:", e, i); }
      render(){ return this.state.hasError ? (
        <div className="min-h-screen flex items-center justify-center bg-red-50 p-8"><div className="bg-white p-10 rounded-xl shadow-xl text-center"><h1 className="text-2xl font-bold text-red-800 mb-2">Произошла ошибка</h1><p className="text-gray-600">К сожалению, приложение не может быть загружено.</p></div></div>
      ) : this.props.children; }
    }

    (function mount(){
      const el=document.getElementById('root');
      try{
        const root=ReactDOM.createRoot(el);
        root.render(<ErrorBoundary><Root/></ErrorBoundary>);
      }catch(e){
        ReactDOM.render(<ErrorBoundary><Root/></ErrorBoundary>, el);
      }
    })();
  </script>

  <noscript>
    <div style="padding:16px;border:1px solid #ddd;border-radius:12px;margin:16px;font-family:system-ui">Для запуска нужен JavaScript.</div>
  </noscript>
</body>
</html>
